# Reference from template-project â€” not active, kept for GitHub Actions migration reference
name: "Load Testing for Fund A Scholar"

trigger: none

parameters:
  - name: environment
    displayName: Select the environment
    type: string
    default: dev
    values:
      - dev
      - test
      - prod
  - name: testName
    displayName: Select the test name
    type: string
    default: scholars-test
    values:
      - scholars-test
      - scholar-test
      - filters-options-test

variables:
  - ${{ if eq(parameters.environment, 'test') }}:
      - group: test
  - ${{ if eq(parameters.environment, 'dev') }}:
      - group: dev
  - ${{ if eq(parameters.environment, 'prod') }}:
      - group: prod

jobs:
  - job: RunLoadTesting
    displayName: "Run Load Testing"
    pool:
      vmImage: "ubuntu-latest"
    steps:
      - script: |
          set -e
          echo "Selected environment: ${{ parameters.environment }}"
          echo '{"testName": "${{ parameters.testName }}"}' > /tmp/lambda-payload.json
          echo "Invoking load testing Lambda: fundascholar-${{ parameters.environment }}-load-testing"

          echo "Payload content:"
          cat /tmp/lambda-payload.json
          PAYLOAD_BASE64=$(base64 -i /tmp/lambda-payload.json)

          aws lambda invoke \
            --function-name fundascholar-${{ parameters.environment }}-load-testing \
            --payload "$PAYLOAD_BASE64" \
            output.json
          rm -f /tmp/lambda-payload.json
        env:
          AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
          AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
          AWS_REGION: $(AWS_REGION)
        displayName: "Start load testing"

      - script: |
          set -e
          echo "ECS task output:"
          cat output.json
        displayName: "Display Lambda output"
